# --- Nginx å…¨å±€é…ç½® ---
pid /etc/nginx/logs/nginx.pid;
error_log /usr/local/src/nginx/nginx-1.26.0/logs/error.log;

events {
    worker_connections 1024;
}
http {
    # WebSocket è¿æ¥å‡çº§æ”¯æŒ (å¯¹VMess+WSç­‰ä»£ç†è‡³å…³é‡è¦)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # è®¾ç½®æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°ä¸º 100MB
    client_max_body_size 100M;

    # é»˜è®¤ SSL é…ç½®
    ssl_certificate /opt/siffcity.pem;
    ssl_certificate_key /opt/siffcity.key;
    
    # æ—¥å¿—è®¾ç½®
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$upstream_cache_status" '
                      '$request_time $upstream_response_time $pipe';
    access_log  /etc/nginx/logs/access.log  main;
    # åå‘ä»£ç†ç¼“å­˜è®¾ç½®
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=chhsai_cache:10m max_size=10g inactive=60m use_temp_path=off;

    # -------------------------------------------------------------------------------------
    # ğŸ“¦ ArgoSB (VMess) èŠ‚ç‚¹é…ç½®æ¨¡æ¿

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        
        # å®šä¹‰ç”¨äº ArgoSB èŠ‚ç‚¹çš„åŸŸå
        server_name argosb.siffcity.sbs; 

        ssl_certificate /opt/siffcity.pem;
        ssl_certificate_key /opt/siffcity.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # `agsb-v2.py` ç”Ÿæˆçš„è·¯å¾„æ˜¯ `/{uuid[:8]}-vm`
        # å‡è®¾ UUID æ˜¯ a91b59b6-ade4-497d-b4e9-88d184c48048, è·¯å¾„å°±æ˜¯ /a91b59b6-vm
        location /a91b59b6-vm { # æˆä½ è„šæœ¬ç”Ÿæˆçš„å®é™…è·¯å¾„
            proxy_pass http://127.0.0.1:49999; # æˆä½ sing-boxç›‘å¬çš„æœ¬åœ°ç«¯å£
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # æ ¹ç›®å½•å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªä¼ªè£…é¡µé¢
        location / {
            root /var/www/html/argosb; # ä¸ºä½ å‡†å¤‡çš„ä¼ªè£…ç½‘é¡µç›®å½•
            index index.html;
            try_files $uri $uri/ =404;
        }
    }
    
    # -------------------------------------------------------------------------------------
    # ğŸ›¡ï¸ Hysteria2 (Web ä¼ªè£…) é…ç½®æ¨¡æ¿
    # -------------------------------------------------------------------------------------
    # è¯´æ˜:
    # è¿™ä¸ª server å—ç”¨äº `nginx-hysteria2.py` è„šæœ¬çš„Webä¼ªè£…ã€‚
    # Hysteria2 æœåŠ¡æœ¬èº«ç›‘å¬åœ¨ UDP ç«¯å£ (ä¾‹å¦‚ 443/udp)ã€‚
    # Nginx ç›‘å¬åœ¨ TCP ç«¯å£ (ä¾‹å¦‚ 443/tcp)ï¼Œå½“æœ‰æ­£å¸¸çš„æµè§ˆå™¨è®¿é—®æ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªä¼ªè£…ç½‘ç«™ã€‚
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;

        # å®šä¹‰ç”¨äº Hysteria2 ä¼ªè£…çš„åŸŸå
        server_name hy2.siffcity.sbs; 

        ssl_certificate /opt/siffcity.pem;
        ssl_certificate_key /opt/siffcity.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # `nginx-hysteria2.py` è„šæœ¬ä¼šåœ¨ `~/.hysteria2/web` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¼ªè£…ç½‘ç«™ã€‚
        # å°† root æŒ‡å‘é‚£ä¸ªç›®å½•ã€‚
        root /root/.hysteria2/web; 
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }
    }
    # å¼ºåˆ¶ HTTP åˆ° HTTPS é‡å®šå‘
    server {
        listen 80;
        listen [::]:80;
        server_name siffcity.sbs aki.siffcity.sbs new.siffcity.sbs ai.siffcity.sbs chat.siffcity.sbs aci.siffcity.sbs vpn.siffcity.sbs ari.siffcity.sbs api.siffcity.sbs tr.siffcity.sbs;
        
        # é‡å®šå‘æ‰€æœ‰ HTTP è¯·æ±‚åˆ° HTTPS
        return 301 https://$host$request_uri;
    }


    # vpn.siffcity.sbs -> æœ¬æœº8080ç«¯å£
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name vpn.siffcity.sbs;

        # CORS å¤´éƒ¨è®¾ç½®
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;


        # å½“è®¿é—® https://vpn.siffcity.sbs/clash.yaml ç­‰é“¾æ¥æ—¶ï¼Œ
        # è¯·æ±‚å°†è¢«è½¬å‘åˆ°æœ¬åœ°çš„ 127.0.0.1:8080 æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡æ˜¯ç”± nginx-hysteria2.py è„šæœ¬å¯åŠ¨çš„ã€‚
        location ~* \.(yaml|txt|json)$ {
            proxy_pass http://127.0.0.1:8080; # è½¬å‘åˆ°Pythonæ–‡ä»¶æœåŠ¡å™¨
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è®¾ç½®å¤´ä¿¡æ¯ä»¥å¼ºåˆ¶ä¸‹è½½
            add_header Content-Disposition 'attachment';
        }
        
        # å…¶ä»– vpn.siffcity.sbs çš„è¯·æ±‚ï¼Œæ­£å¸¸ä»£ç†åˆ° 8080 ç«¯å£
        location / {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }


    # --- Hysteria2 Clash Subscription (Proxy Mode Test) ---
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name sub.chiangma.com;

        # SSLè¯ä¹¦é…ç½®ä¿æŒä¸å˜
        ssl_certificate /opt/chiangma.org.pem;
        ssl_certificate_key /opt/chiangma.org.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # æ·»åŠ å®‰å…¨å¤´
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # å°†æ‰€æœ‰è¯·æ±‚åå‘ä»£ç†åˆ°æœ¬åœ°çš„ 8187 ç«¯å£
        location / {
            proxy_pass http://127.0.0.1:8187;
            
            # --- æ·»åŠ æ ‡å‡†çš„åå‘ä»£ç†å¤´éƒ¨ä¿¡æ¯ ---
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # --- Hysteria2 Web ä¼ªè£… (é»˜è®¤æœåŠ¡å™¨) ---
    # è¯¥é…ç½®å—ç”¨äºå¤„ç†ç›´æ¥è®¿é—®æœåŠ¡å™¨ IP åœ°å€çš„è¯·æ±‚
    server {
        # ç›‘å¬ 443 ç«¯å£ï¼Œå¹¶ä½¿ç”¨ "default_server" æ ‡å¿—

        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        http2 on;

        # ä½¿ç”¨ "_"ä½œä¸ºé€šé…ç¬¦ï¼Œå¯ä»¥åŒ¹é…æ‰€æœ‰æœªæŒ‡å®šçš„åŸŸåå’Œç›´æ¥çš„IPè®¿é—®
        server_name _; 

        # ä½¿ç”¨ Hysteria2 è„šæœ¬ç”Ÿæˆçš„è‡ªç­¾åè¯ä¹¦
        ssl_certificate /root/.hysteria2/cert/server.crt;
        ssl_certificate_key /root/.hysteria2/cert/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # æŒ‡å‘ Hysteria2 è„šæœ¬åˆ›å»ºçš„ä¼ªè£…ç½‘é¡µç›®å½•
        root /root/.hysteria2/web;
        index index.html;

        # (å¯é€‰) ä¸ºæ­¤ä¼ªè£…æœåŠ¡è®¾ç½®ç‹¬ç«‹çš„è®¿é—®æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•
        # access_log /var/log/nginx/hysteria2-facade.log;
        
        # è¿”å›ä¸€ä¸ªé€šç”¨çš„ 404 é”™è¯¯ï¼Œæˆ–è€…æ˜¾ç¤ºä¼ªè£…é¡µé¢
        location / {
            try_files $uri $uri/ =404;
        }
    }

}
