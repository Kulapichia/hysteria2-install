# --- Nginx 全局配置 ---
pid /etc/nginx/logs/nginx.pid;
error_log /usr/local/src/nginx/nginx-1.26.0/logs/error.log;

events {
    worker_connections 1024;
}
http {
    # WebSocket 连接升级支持 (对VMess+WS等代理至关重要)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # 设置最大上传文件大小为 100MB
    client_max_body_size 100M;

    # 默认 SSL 配置
    ssl_certificate /opt/siffcity.pem;
    ssl_certificate_key /opt/siffcity.key;
    
    # 日志设置
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$upstream_cache_status" '
                      '$request_time $upstream_response_time $pipe';
    access_log  /etc/nginx/logs/access.log  main;
    # 反向代理缓存设置
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=chhsai_cache:10m max_size=10g inactive=60m use_temp_path=off;


    # --- Hysteria2 Clash Subscription (Proxy Mode Test) ---
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name sub.siffcity.sbs;

        # SSL证书配置保持不变
        ssl_certificate /opt/siffcity.pem;
        ssl_certificate_key /opt/siffcity.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # 添加安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # 将所有请求反向代理到本地的 8187 端口
        location / {
            proxy_pass http://127.0.0.1:8187;
            
            # --- 添加标准的反向代理头部信息 ---
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

}
